import React, { useState } from 'react';
import {
  Box,
  Typography,
  Button,
  Card,
  Avatar,
  IconButton,
  Divider,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Grid,
} from '@mui/material';
import {
  Visibility as VisibilityIcon,
  ShoppingCart as ShoppingCartIcon,
  MoreVert as MoreVertIcon,
  Sms as SmsIcon,
  Email as EmailIcon,
  Close as CloseIcon,
  KeyboardArrowRight as KeyboardArrowRightIcon,
  Public as PublicIcon,
  Person as PersonIcon,
  Login as LoginIcon,
  Sell as SellIcon
} from '@mui/icons-material';
import RichTextEditor from '../common/RichTextEditor';
import { Customer } from '../../types/Customer';

// İsim baş harflerini alma fonksiyonu
const getInitials = (name: string): string => {
  return name
    .split(' ')
    .map(part => part[0])
    .join('')
    .toUpperCase();
};

// İsimden renk oluşturma fonksiyonu (kullanılmıyor)
// const stringToColor = (string: string): string => {
//   let hash = 0;
//   for (let i = 0; i < string.length; i++) {
//     hash = string.charCodeAt(i) + ((hash << 5) - hash);
//   }
//   let color = '#';
//   for (let i = 0; i < 3; i++) {
//     const value = (hash >> (i * 8)) & 0xff;
//     color += `00${value.toString(16)}`.slice(-2);
//   }
//   return color;
// };

interface CustomerCardProps {
  customer: Customer;
  onClick?: () => void;
  onMenuOpen?: (event: React.MouseEvent<HTMLElement>, customer: Customer) => void;
}

const CustomerCard: React.FC<CustomerCardProps> = ({ customer, onMenuOpen }) => {
  const [openSmsDialog, setOpenSmsDialog] = useState(false);
  const [openEmailDialog, setOpenEmailDialog] = useState(false);
  const [smsMessage, setSmsMessage] = useState('');
  const [emailSubject, setEmailSubject] = useState('');
  const [emailBody, setEmailBody] = useState('');
  
  // SMS Dialog açma/kapama
  const handleOpenSmsDialog = () => setOpenSmsDialog(true);
  const handleCloseSmsDialog = () => setOpenSmsDialog(false);
  
  // Email Dialog açma/kapama
  const handleOpenEmailDialog = () => setOpenEmailDialog(true);
  const handleCloseEmailDialog = () => setOpenEmailDialog(false);
  
  // SMS gönderme işlevi
  const handleSendSms = () => {
    console.log('SMS gönderiliyor:', { to: customer.phone, message: smsMessage });
    // Burada SMS gönderme API çağrısı yapılacak
    handleCloseSmsDialog();
    // Başarılı gönderim bildirimi gösterilebilir
  };
  
  // E-posta gönderme işlevi
  const handleSendEmail = () => {
    console.log('E-posta gönderiliyor:', { 
      to: customer.email, 
      subject: emailSubject, 
      body: emailBody 
    });
    // Burada e-posta gönderme API çağrısı yapılacak
    handleCloseEmailDialog();
    // Başarılı gönderim bildirimi gösterilebilir
  };
  
  // Menü açma işlevi
  const handleMenuOpen = (event: React.MouseEvent<HTMLElement>) => {
    if (onMenuOpen) {
      onMenuOpen(event, customer);
    }
  };
  return (
    <Card sx={{ 
      position: 'relative',
      overflow: 'visible',
      borderRadius: 2,
      boxShadow: '0 4px 20px rgba(0,0,0,0.08)',
      border: '1px solid #f0f0f0',
      transition: 'all 0.3s ease',
      '&:hover': {
        boxShadow: '0 8px 24px rgba(0,0,0,0.12)',
        transform: 'translateY(-4px)'
      },
      // Aksan rengi alt çizgi
      borderBottom: '4px solid #ff5722'
    }}>
      {/* Kart Üst Kısım - Gradient Başlık */}
      <Box sx={{ 
        height: 90, 
        background: 'linear-gradient(135deg, #25638f 0%, #1e5172 100%)',
        borderTopLeftRadius: 8,
        borderTopRightRadius: 8,
        display: 'flex',
        alignItems: 'center',
        px: 3,
        position: 'relative',
        justifyContent: 'space-between'
      }}>
        <Box sx={{ 
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          opacity: 0.1,
          backgroundImage: 'url("data:image/svg+xml,%3Csvg width=\'100\' height=\'100\' viewBox=\'0 0 100 100\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z\' fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'/%3E%3C/svg%3E")',
          backgroundSize: '24px 24px'
        }} />
        
        <Box sx={{ display: 'flex', alignItems: 'center' }}>
          {/* Üç Nokta Menü Butonu */}
          <IconButton 
            size="small" 
            onClick={(e) => onMenuOpen && onMenuOpen(e, customer)}
            sx={{ 
              color: 'white',
              bgcolor: 'rgba(255,255,255,0.15)',
              mr: 1,
              width: 36,
              height: 36,
              '&:hover': {
                bgcolor: 'rgba(255,255,255,0.25)'
              }
            }}
          >
            <MoreVertIcon fontSize="small" />
          </IconButton>
          
          {/* Durum Etiketi */}
          <Box sx={{ 
            background: 'linear-gradient(90deg, #ff5722 0%, #ff7043 100%)',
            color: 'white',
            fontSize: '0.75rem',
            fontWeight: 600,
            py: 0.5,
            px: 2,
            borderRadius: 20,
            boxShadow: '0 2px 8px rgba(255,87,34,0.3)',
            letterSpacing: '0.5px',
            textTransform: 'uppercase'
          }}>
            {customer.status}
          </Box>
        </Box>
      </Box>
      
      {/* Avatar */}
      <Box sx={{ 
        position: 'relative', 
        display: 'flex', 
        justifyContent: 'center',
        mt: -6,
        mb: 2,
        zIndex: 1
      }}>
        <Avatar 
          src={`https://randomuser.me/api/portraits/${customer.id.charCodeAt(0) % 2 === 0 ? 'men' : 'women'}/${customer.id.charCodeAt(0) % 10}.jpg`}
          sx={{ 
            width: 100,
            height: 100,
            border: '5px solid white',
            boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
          }}
        >
          {getInitials(customer.name)}
        </Avatar>
      </Box>
      
      {/* Müşteri Adı ve Müşteri Kodu */}
      <Box sx={{ 
        mx: 2, 
        p: 2, 
        mb: 1,
        textAlign: 'center'
      }}>
        {/* Müşteri Adı */}
        <Typography 
          variant="h6" 
          sx={{ 
            fontWeight: 700, 
            mb: 1, 
            fontSize: '1.25rem',
            color: '#333',
            letterSpacing: '0.5px'
          }}
        >
          {customer.name}
        </Typography>
        
        {/* Müşteri Kodu */}
        <Box sx={{ 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center',
          bgcolor: '#f5f9ff',
          borderRadius: 10,
          py: 0.5,
          px: 2,
          width: 'fit-content',
          margin: '0 auto'
        }}>
          <Typography variant="body2" color="text.secondary" sx={{ fontSize: '0.8rem', mr: 0.5 }}>
            Müşteri Kodu:
          </Typography>
          <Typography variant="body2" sx={{ fontSize: '0.8rem', fontWeight: 600, color: 'primary.main' }}>
            {customer.id}
          </Typography>
        </Box>
      </Box>
      
      {/* Ülke/Şehir ve Sipariş Bilgileri */}
      <Box sx={{ 
        display: 'flex', 
        mt: 1, 
        px: 2, 
        gap: 2
      }}>
        <Box sx={{ 
          flex: 1, 
          bgcolor: '#f8f8f8', 
          p: 2, 
          borderRadius: 2, 
          boxShadow: 'inset 0 1px 3px rgba(0,0,0,0.05)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center'
        }}>
          <Box sx={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            bgcolor: 'rgba(37, 99, 143, 0.1)', 
            borderRadius: '50%',
            p: 1,
            mb: 1
          }}>
            <PublicIcon sx={{ color: 'primary.main', fontSize: '1.2rem' }} />
          </Box>
          <Typography variant="caption" sx={{ color: '#757575', display: 'block', mb: 0.5, textAlign: 'center' }}>
            Ülke/Şehir
          </Typography>
          <Typography variant="body2" sx={{ fontWeight: 600, textAlign: 'center' }}>
            {customer.country} {customer.city ? `/ ${customer.city}` : ''}
          </Typography>
        </Box>
        <Box sx={{ 
          flex: 1, 
          bgcolor: '#f8f8f8', 
          p: 2, 
          borderRadius: 2, 
          boxShadow: 'inset 0 1px 3px rgba(0,0,0,0.05)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center'
        }}>
          <Box sx={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            bgcolor: 'rgba(63, 81, 181, 0.1)', 
            borderRadius: '50%',
            p: 1,
            mb: 1
          }}>
            <ShoppingCartIcon sx={{ color: '#3f51b5', fontSize: '1.2rem' }} />
          </Box>
          <Typography variant="caption" sx={{ color: '#757575', display: 'block', mb: 0.5, textAlign: 'center' }}>
            Sipariş Sayısı
          </Typography>
          <Typography variant="body2" sx={{ fontWeight: 600, color: '#3f51b5', textAlign: 'center' }}>
            {customer.orders || customer.siparisler || 8}
          </Typography>
        </Box>
      </Box>
      
      {/* Son Giriş ve Taraf */}
      <Box sx={{ 
        display: 'flex', 
        mt: 2, 
        px: 2, 
        gap: 2
      }}>
        <Box sx={{ 
          flex: 1, 
          bgcolor: '#f8f8f8', 
          p: 2, 
          borderRadius: 2, 
          boxShadow: 'inset 0 1px 3px rgba(0,0,0,0.05)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center'
        }}>
          <Box sx={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            bgcolor: 'rgba(117, 117, 117, 0.1)', 
            borderRadius: '50%',
            p: 1,
            mb: 1
          }}>
            <LoginIcon sx={{ color: '#757575', fontSize: '1.2rem' }} />
          </Box>
          <Typography variant="caption" sx={{ color: '#757575', display: 'block', mb: 0.5, textAlign: 'center' }}>
            Son Giriş
          </Typography>
          <Typography variant="body2" sx={{ fontWeight: 600, textAlign: 'center' }}>
            {customer.lastLogin || '24/01/2025:11:20'}
          </Typography>
        </Box>
        <Box sx={{ 
          flex: 1, 
          bgcolor: '#f8f8f8', 
          p: 2, 
          borderRadius: 2, 
          boxShadow: 'inset 0 1px 3px rgba(0,0,0,0.05)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center'
        }}>
          <Box sx={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            bgcolor: 'rgba(255, 87, 34, 0.1)', 
            borderRadius: '50%',
            p: 1,
            mb: 1
          }}>
            <PersonIcon sx={{ color: '#ff5722', fontSize: '1.2rem' }} />
          </Box>
          <Typography variant="caption" sx={{ color: '#757575', display: 'block', mb: 0.5, textAlign: 'center' }}>
            Taraf
          </Typography>
          <Typography variant="body2" sx={{ fontWeight: 600, color: '#ff5722', textAlign: 'center' }}>
            {customer.party === 'buyer' ? 'Alıcı' : customer.party === 'seller' ? 'Satıcı' : 'Alıcı'}
          </Typography>
        </Box>
      </Box>
      
      {/* Finansal Bilgiler */}
      <Box sx={{ 
        mt: 2, 
        mx: 2,
        p: 2, 
        bgcolor: '#f8f8f8',
        borderRadius: 2,
        boxShadow: 'inset 0 1px 3px rgba(0,0,0,0.05)',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center'
      }}>
        <Box sx={{ display: 'flex', alignItems: 'center' }}>
          <Box sx={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            bgcolor: (customer.bakiye || customer.balance || 0) > 0 ? 'rgba(76, 175, 80, 0.1)' : 
                    (customer.bakiye || customer.balance || 0) < 0 ? 'rgba(244, 67, 54, 0.1)' : 
                    'rgba(117, 117, 117, 0.1)', 
            borderRadius: '50%',
            p: 1,
            mr: 2
          }}>
            <SellIcon sx={{ 
              color: (customer.bakiye || customer.balance || 0) > 0 ? '#4caf50' : 
                     (customer.bakiye || customer.balance || 0) < 0 ? '#f44336' : 
                     '#757575', 
              fontSize: '1.2rem' 
            }} />
          </Box>
          <Typography variant="body2" sx={{ fontWeight: 500, color: '#757575' }}>
            Bakiye
          </Typography>
        </Box>
        <Typography variant="body1" sx={{ 
          fontWeight: 700, 
          color: (customer.bakiye || customer.balance || 0) > 0 ? '#4caf50' : 
                (customer.bakiye || customer.balance || 0) < 0 ? '#f44336' : '#757575'
        }}>
          {(customer.bakiye || customer.balance || 0).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}
        </Typography>
      </Box>
      
      {/* İletişim Butonları */}
      <Box sx={{ 
        display: 'flex', 
        gap: 2, 
        mt: 2, 
        mx: 2, 
        p: 2,
        mb: 2
      }}>
        <Button
          variant="contained"
          startIcon={<SmsIcon />}
          onClick={handleOpenSmsDialog}
          sx={{ 
            flex: 1, 
            bgcolor: 'primary.main', 
            borderRadius: 2,
            py: 1,
            boxShadow: '0 4px 12px rgba(37, 99, 143, 0.2)',
            '&:hover': { 
              bgcolor: 'primary.dark',
              boxShadow: '0 6px 16px rgba(37, 99, 143, 0.3)'
            } 
          }}
        >
          SMS Gönder
        </Button>
        <Button
          variant="contained"
          startIcon={<EmailIcon />}
          onClick={handleOpenEmailDialog}
          sx={{ 
            flex: 1, 
            bgcolor: '#ff5722', 
            borderRadius: 2,
            py: 1,
            boxShadow: '0 4px 12px rgba(255, 87, 34, 0.2)',
            '&:hover': { 
              bgcolor: '#e64a19',
              boxShadow: '0 6px 16px rgba(255, 87, 34, 0.3)'
            } 
          }}
        >
          E-posta Gönder
        </Button>
      </Box>
      
          </Box>
        </Box>
      </Box>
      
      {/* Butonlar */}
      <Box sx={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        p: 2, 
        mt: 2,
        borderTop: '1px solid #f0f0f0'
      }}>
        <Button 
          variant="outlined" 
          size="medium" 
          startIcon={<VisibilityIcon />}
          sx={{ 
            color: '#25638f', 
            borderColor: '#25638f',
            fontSize: '0.85rem', 
            textTransform: 'none',
            py: 0.75,
            px: 2,
            borderRadius: 4,
            '&:hover': {
              borderColor: '#25638f',
              bgcolor: 'rgba(37, 99, 143, 0.04)'
            }
          }}
        >
          Profil
        </Button>
        <Button 
          variant="contained" 
          size="medium" 
          startIcon={<ShoppingCartIcon />}
          sx={{ 
            bgcolor: '#25638f', 
            '&:hover': { bgcolor: '#1e4f72' },
            fontSize: '0.85rem',
            py: 0.75,
            px: 2,
            borderRadius: 4,
            textTransform: 'none'
          }}
        >
          Satışlar
        </Button>
      </Box>

      {/* SMS Dialog */}
      {/* SMS Dialog */}
      <Dialog open={openSmsDialog} onClose={handleCloseSmsDialog} maxWidth="sm" fullWidth>
        <DialogTitle sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: '#25638f', color: 'white' }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <SmsIcon />
            <Typography variant="h6">SMS Gönder</Typography>
          </Box>
          <IconButton onClick={handleCloseSmsDialog} sx={{ color: 'white' }}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent sx={{ mt: 2 }}>
          <Grid container spacing={2}>
            <Grid item xs={12}>
              <TextField label="Alıcı" value={customer.phone || 'telefon bilgisi yok'} fullWidth disabled variant="outlined" margin="normal" />
            </Grid>
            <Grid item xs={12}>
              <TextField label="Mesaj" value={smsMessage} onChange={(e) => setSmsMessage(e.target.value)} fullWidth multiline rows={4} variant="outlined" margin="normal" placeholder="SMS mesajınızı buraya yazın..." />
            </Grid>
          </Grid>
        </DialogContent>
        <DialogActions sx={{ p: 2, borderTop: '1px solid #eee' }}>
          <Button onClick={handleCloseSmsDialog} variant="outlined">
            İptal
          </Button>
          <Button 
            onClick={handleSendSms} 
            variant="contained" 
            sx={{ bgcolor: '#25638f', '&:hover': { bgcolor: '#1e5070' } }}
          >
            Gönder
          </Button>
        </DialogActions>
      </Dialog>

      {/* E-posta Dialog */}
      <Dialog open={openEmailDialog} onClose={handleCloseEmailDialog} maxWidth="md" fullWidth>
        <DialogTitle sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: '#25638f', color: 'white' }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <EmailIcon />
            <Typography variant="h6">E-posta Gönder</Typography>
          </Box>
          <IconButton onClick={handleCloseEmailDialog} sx={{ color: 'white' }}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent sx={{ mt: 2 }}>
          <Grid container spacing={2}>
            <Grid item xs={12}>
              <TextField
                label="Alıcı"
                value={customer.email || 'musteri@example.com'}
                fullWidth
                disabled
                variant="outlined"
                margin="normal"
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                label="Konu"
                value={emailSubject}
                onChange={(e) => setEmailSubject(e.target.value)}
                fullWidth
                variant="outlined"
                margin="normal"
                placeholder="E-posta konusu..."
              />
            </Grid>
            <Grid item xs={12}>
              <Typography variant="subtitle2" sx={{ mb: 1 }}>
                Mesaj
              </Typography>
              <RichTextEditor
                value={emailBody}
                onChange={setEmailBody}
                placeholder="Mesajınızı buraya yazın..."
                minRows={8}
                maxRows={12}
              />
            </Grid>
          </Grid>
        </DialogContent>
        <DialogActions sx={{ p: 2, borderTop: '1px solid #eee' }}>
          <Button onClick={handleCloseEmailDialog} variant="outlined">
            İptal
          </Button>
          <Button 
            onClick={handleSendEmail} 
            variant="contained" 
            sx={{ bgcolor: '#25638f', '&:hover': { bgcolor: '#1e5070' } }}
          >
            Gönder
          </Button>
        </DialogActions>
      </Dialog>
    </Card>
  );
};

export default CustomerCard;
